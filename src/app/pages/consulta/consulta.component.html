<div class="modulo-consultas">
  <div class="cabecalho">
    <div class="cabecalho-info">
      <h2>ğŸ“‹ HistÃ³rico de Consultas</h2>
      <p class="subtitulo">Gerenciamento por paciente</p>
    </div>
    <div class="estatisticas">
      <div class="stat-card">
        <span class="stat-numero">{{ pacientesComConsultas.length }}</span>
        <span class="stat-label">Pacientes</span>
      </div>
      <div class="stat-card">
        <span class="stat-numero">{{ getTotalConsultas() }}</span>
        <span class="stat-label">Consultas</span>
      </div>
    </div>
  </div>

  <div class="barra-busca">
    <div class="input-wrapper">
      <span class="icone-busca">ğŸ”</span>
      <input 
        type="text" 
        placeholder="Buscar paciente por nome ou email..." 
        [(ngModel)]="termoBusca"
        (input)="buscarPacientes()"
        class="input-busca">
    </div>
  </div>

  <!-- FormulÃ¡rio de Consulta -->
  <div class="formulario-overlay" *ngIf="mostrarFormulario">
    <div class="formulario-card">
      <div class="formulario-header">
        <h3>{{ consultaAtual.id_ficha ? 'âœï¸ Editar Consulta' : 'â• Nova Consulta' }}</h3>
        <button class="btn-fechar" (click)="cancelar()">âœ•</button>
      </div>
      
      <form (ngSubmit)="salvarConsulta()">
        <div class="form-row">
          <div class="form-group">
            <label>ğŸ“… Data da Consulta *</label>
            <input type="date" [(ngModel)]="consultaAtual.data_consulta" name="data_consulta" required>
          </div>
          <div class="form-group">
            <label>ğŸ• HorÃ¡rio *</label>
            <input type="time" [(ngModel)]="consultaAtual.horario_consulta" name="horario_consulta" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ğŸ“ Tipo de Consulta *</label>
            <select [(ngModel)]="consultaAtual.tipo" name="tipo" required>
              <option value="primeira">ğŸŒŸ Primeira Consulta</option>
              <option value="retorno">ğŸ”„ Retorno</option>
              <option value="avaliacao">ğŸ“Š AvaliaÃ§Ã£o</option>
            </select>
          </div>
          <div class="form-group">
            <label>ğŸ¯ Objetivo *</label>
            <input type="text" [(ngModel)]="consultaAtual.objetivo" name="objetivo" 
                   placeholder="Ex: Perda de peso" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ğŸ“ Altura (m) *</label>
            <input type="number" step="0.01" [(ngModel)]="consultaAtual.altura" 
                   name="altura" (input)="calcularIMC()" placeholder="Ex: 1.65" required>
          </div>
          <div class="form-group">
            <label>âš–ï¸ Peso Atual (kg) *</label>
            <input type="number" step="0.1" [(ngModel)]="consultaAtual.peso_atual" 
                   name="peso_atual" (input)="calcularIMC()" placeholder="Ex: 72.5" required>
          </div>
        </div>

        <div class="imc-card" *ngIf="consultaAtual.imc">
          <div class="imc-resultado" [style.background-color]="getCorIMC(consultaAtual.imc!)">
            <div class="imc-info">
              <span class="imc-label">IMC Calculado</span>
              <span class="imc-valor">{{ consultaAtual.imc }}</span>
            </div>
            <span class="imc-classificacao">{{ getClassificacaoIMC(consultaAtual.imc!) }}</span>
          </div>
        </div>

        <div class="form-group">
          <label>ğŸ’Š MedicaÃ§Ãµes em Uso</label>
          <textarea [(ngModel)]="consultaAtual.medicacoes_uso" name="medicacoes_uso" 
                    rows="3" placeholder="Descreva as medicaÃ§Ãµes em uso"></textarea>
        </div>

        <div class="form-acoes">
          <button type="button" class="btn-secundario" (click)="cancelar()">Cancelar</button>
          <button type="submit" class="btn-primario">
            <span *ngIf="!consultaAtual.id_ficha">â• Adicionar</span>
            <span *ngIf="consultaAtual.id_ficha">ğŸ’¾ Salvar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Listagem de Pacientes com Consultas -->
  <div class="lista-pacientes">
    <div class="paciente-ficha" *ngFor="let paciente of pacientesFiltrados">
      <div class="paciente-header" (click)="togglePaciente(paciente)">
        <div class="paciente-info">
          <div class="paciente-avatar" [class.feminino]="paciente.sexo === 'feminino'" [class.masculino]="paciente.sexo === 'masculino'">
            {{ paciente.nome.charAt(0) }}{{ paciente.sobrenome.charAt(0) }}
          </div>
          <div class="paciente-dados">
            <h3>{{ paciente.nome }} {{ paciente.sobrenome }}</h3>
            <div class="paciente-detalhes">
              <span class="detalhe"><span class="icone">ğŸ“§</span> {{ paciente.email }}</span>
              <span class="detalhe"><span class="icone">ğŸ“±</span> {{ paciente.celular }}</span>
              <span class="detalhe"><span class="icone">ğŸ‚</span> {{ calcularIdade(paciente.data_nascimento) }} anos</span>
            </div>
          </div>
        </div>
        <div class="paciente-acoes">
          <div class="consultas-badge">
            <span class="badge-numero">{{ paciente.consultas.length }}</span>
            <span class="badge-texto">consultas</span>
          </div>
          <button class="btn-adicionar" (click)="novaConsulta(paciente); $event.stopPropagation()">
            â• Nova Consulta
          </button>
          <span class="icone-expandir" [class.expandido]="paciente.expandido">â–¼</span>
        </div>
      </div>

      <div class="consultas-lista" [class.expandido]="paciente.expandido">
        <div class="consulta-card" *ngFor="let consulta of paciente.consultas">
          <div class="consulta-timeline">
            <div class="timeline-dot" [class]="'tipo-' + consulta.tipo"></div>
            <div class="timeline-line"></div>
          </div>
          
          <div class="consulta-conteudo">
            <div class="consulta-header-inline">
              <div class="consulta-data-hora">
                <span class="data">ğŸ“… {{ formatarData(consulta.data_consulta) }}</span>
                <span class="hora">ğŸ• {{ consulta.horario_consulta }}</span>
                <span class="badge badge-tipo" [class]="'badge-' + consulta.tipo">
                  {{ consulta.tipo }}
                </span>
              </div>
              <div class="consulta-acoes-inline">
                <button class="btn-icone editar" (click)="editarConsulta(consulta)" title="Editar">
                  âœï¸
                </button>
                <button class="btn-icone excluir" (click)="excluirConsulta(paciente, consulta.id_ficha!)" title="Excluir">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>

            <div class="consulta-objetivo">
              <span class="label">ğŸ¯ Objetivo:</span>
              <span class="valor">{{ consulta.objetivo }}</span>
            </div>

            <div class="consulta-metricas">
              <div class="metrica">
                <span class="metrica-icone">ğŸ“</span>
                <div class="metrica-info">
                  <span class="metrica-label">Altura</span>
                  <span class="metrica-valor">{{ consulta.altura }} m</span>
                </div>
              </div>
              <div class="metrica">
                <span class="metrica-icone">âš–ï¸</span>
                <div class="metrica-info">
                  <span class="metrica-label">Peso</span>
                  <span class="metrica-valor">{{ consulta.peso_atual }} kg</span>
                </div>
              </div>
              <div class="metrica destaque">
                <span class="metrica-icone">ğŸ“Š</span>
                <div class="metrica-info">
                  <span class="metrica-label">IMC</span>
                  <span class="metrica-valor" [style.color]="getCorIMC(consulta.imc!)">{{ consulta.imc }}</span>
                  <span class="metrica-classificacao">{{ getClassificacaoIMC(consulta.imc!) }}</span>
                </div>
              </div>
            </div>

            <div class="consulta-medicacoes" *ngIf="consulta.medicacoes_uso">
              <span class="label">ğŸ’Š MedicaÃ§Ãµes:</span>
              <span class="valor">{{ consulta.medicacoes_uso }}</span>
            </div>
          </div>
        </div>

        <div class="sem-consultas" *ngIf="paciente.consultas.length === 0">
          <p>ğŸ“‹ Nenhuma consulta registrada para este paciente</p>
          <button class="btn-primario-outline" (click)="novaConsulta(paciente)">
            â• Agendar primeira consulta
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="mensagem-vazia" *ngIf="pacientesFiltrados.length === 0">
    <div class="vazio-icone">ğŸ”</div>
    <p>Nenhum paciente encontrado</p>
  </div>
</div>